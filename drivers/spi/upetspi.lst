
upetspi.a65


    4 T:1000                                    ; Low level SPI routines for the Micro-PET SPI interface built into the CPLD
    5 T:1000                                    ;

    7 T:1000                                    ; Connections
    7 T:1000                                    
    8 T:1000                                    ;

   11 T:1000                                     .( 
   12 T:1000                                    SPICTRL=$e808
   13 T:1000                                    SPIDATA=$e809
   14 T:1000                                    SPIPEEK=$e80a

   17 T:1000                                    spi_wra=spi_rxtx
   18 T:1000                                    spi_disable=spi_deselect
   19 T:1000                                    spi_enable=spi_select

   22 T:1000                                    ; init the SPI code
   23 T:1000                           spi_init  .( 

   25 T:1000  a9 00                              lda #0
   26 T:1002  8d 08 e8                           sta SPICTRL

   28 T:1005                                    ; no externally controllable RESET of the MAX3421 here

   30 T:1005  60                                 rts 
   31 T:1006                                     .) 

   33 T:1006                                    ; select the device
   34 T:1006                           spi_select .( 
   35 T:1006                                    ;lda #SPI_3421
   36 T:1006  8d 08 e8                           sta SPICTRL
   37 T:1009  60                                 rts 
   38 T:100a                                     .) 

   40 T:100a                                    ; deselect the device
   41 T:100a                           spi_deselect .( 
   42 T:100a  a9 00                              lda #0
   43 T:100c  8d 08 e8                           sta SPICTRL
   44 T:100f  60                                 rts 
   45 T:1010                                     .) 

   47 T:1010                           spi_rxtx  .( 
   48 T:1010  8d 09 e8                           sta SPIDATA
   49 T:1013  2c 08 e8                 rd        bit SPICTRL
   50 T:1016  30 fb                              bmi rd
   51 T:1018  ad 0a e8                           lda SPIPEEK
   52 T:101b  c9 00                              cmp #0
   53 T:101d  60                                 rts 
   54 T:101e                                     .) 

   56 T:101e                           spi_tx    .( 
   57 T:101e  2c 08 e8                           bit SPICTRL
   58 T:1021  70 fb                              bvs spi_tx
   59 T:1023  8d 09 e8                           sta SPIDATA
   60 T:1026  60                                 rts 
   61 T:1027                                     .) 

   63 T:1027                                     .) 
