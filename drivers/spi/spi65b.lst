
spi65b.a65


    2 T:1000                                     .( 

spi65b.i65


    5 T:1000                                    ETHSEL=$01

    7 T:1000                                    SPIBASE=$e8a0

    9 T:1000                                    SPIDR=(SPIBASE)           ; SPI data port
   10 T:1000                                    SPISR=(SPIBASE+1)     ; SPI status
   11 T:1000                                    SPICR=(SPIBASE+1)     ; SPI control
   12 T:1000                                    SPIDIV=(SPIBASE+2)     ; SPI SCLK divisor (NOTE - lower 4 bits only)
   13 T:1000                                    SPIISRB=(SPIBASE+2)     ; SPI Interrupt status register (upper 4 bits)
   14 T:1000                                    SPISSRB=(SPIBASE+3)     ; SPI Slave Select register (lower 4 bits)
   15 T:1000                                    SPIIERB=(SPIBASE+3)     ; SPI Interrupt enable register (upper 4 bits)

spi65b.a65


    7 T:1000                           spi_init  .( 
    8 T:1000  a9 04                              lda #$04             ; ECE external clock enable, SPI mode 0
    9 T:1002                                    ;lda #$07 ; ECE external clock enable, SPI mode 3
   10 T:1002  8d a1 e8                           sta SPICR
   11 T:1005  a9 00                              lda #0
   12 T:1007  8d a2 e8                           sta SPIDIV
   13 T:100a  a9 0f                              lda #$0f
   14 T:100c  8d a3 e8                           sta SPIIERB                ; no interrupts, no device selected
   15 T:100f  18                                 clc 
   16 T:1010  60                                 rts 
   17 T:1011                                     .) 

   19 T:1011                           spi_enable .( 
   20 T:1011  49 ff                              eor #$ff
   21 T:1013  2d a3 e8                           and SPISSRB
   22 T:1016  8d a3 e8                           sta SPISSRB
   23 T:1019  60                                 rts 
   24 T:101a                                     .) 

   26 T:101a                           spi_disable .( 
   27 T:101a  0d a3 e8                           ora SPISSRB
   28 T:101d  8d a3 e8                           sta SPISSRB
   29 T:1020  60                                 rts 
   30 T:1021                                     .) 

   32 T:1021                           spi_wra   .( 
   33 T:1021  8d a0 e8                           sta SPIDR
   34 T:1024  2c a1 e8                 l_        bit SPISR
   35 T:1027  10 fb                              bpl l_
   36 T:1029  ad a0 e8                           lda SPIDR
   37 T:102c  60                                 rts 
   38 T:102d                                     .) 

   41 T:102d                           spi_wraNR .( 
   42 T:102d  8d a0 e8                           sta SPIDR
   43 T:1030  2c a1 e8                 l_        bit SPISR
   44 T:1033  10 fb                              bpl l_
   45 T:1035  2c a0 e8                           bit SPIDR
   46 T:1038  60                                 rts 
   47 T:1039                                     .) 

   50 T:1039                           spi_checkints .( 
   51 T:1039  ad a2 e8                           lda SPIISRB
   52 T:103c  29 f0                              and #$f0
   53 T:103e  60                                 rts 
   54 T:103f                                     .) 

   57 T:103f                           spi_checkint .( 
   58 T:103f  0a                                 asl 
   59 T:1040  0a                                 asl 
   60 T:1041  0a                                 asl 
   61 T:1042  0a                                 asl 
   62 T:1043  2d a2 e8                           and SPIISRB
   63 T:1046  60                                 rts 
   64 T:1047                                     .) 

   66 T:1047                                     .) 
